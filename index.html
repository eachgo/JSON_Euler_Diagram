<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JSON 可视化 生成欧拉图</title>
    <link rel="icon" href="/favicon.ico" sizes="32x32">
    <link rel="icon" href="/icon.svg" type="image/svg+xml">
    <link rel="apple-touch-icon" href="/apple-touch-icon.png">
    <link rel="manifest" href="/manifest.webmanifest">
    <style>
       
    /* :root 定义了将被各主题具体化的 CSS 变量 */
:root {
    /* 数据类型颜色变量 */
    --color-object: rgba(180, 220, 180, 0.5); /* Default 主题的 OBJECT 颜色 */
    --color-array: rgba(190, 210, 230, 0.5);  /* Default 主题的 ARRAY 颜色 */
    --color-string: rgb(0, 116, 217);
    --color-number: rgb(217, 0, 116);
    --color-boolean-true: rgb(46, 204, 64);
    --color-boolean-false: rgb(255, 65, 54);
    --color-null: rgb(128, 128, 128);

    /* 界面与文本颜色变量 */
    --color-text: #111111;                    /* Default 主题的 TEXT_COLOR */
    --color-viz-background: #ffffff;          /* Default 主题的 VIZ_BACKGROUND */

    /* 派生颜色或特定 UI 元素颜色 (示例) */
    --color-object-label-bg: rgba(198, 227, 198, 0.7); /* Default 主题 OBJECT 标签背景 */
    --color-array-label-bg: rgba(205, 217, 233, 0.7);  /* Default 主题 ARRAY 标签背景 */
    /* 如果叶子节点的背景不是其类型颜色，而是统一的 */
    /* --color-leaf-node-bg: #f0f0f0; */
}

/* 主题定义：覆盖 :root 中的变量值 */
[data-theme="Default"] {
    /* 数据类型颜色变量 */
    --color-object: rgba(180, 220, 180, 0.5); /* Default 主题的 OBJECT 颜色 */
    --color-array: rgba(190, 210, 230, 0.5);  /* Default 主题的 ARRAY 颜色 */
    --color-string: rgb(0, 116, 217);
    --color-number: rgb(217, 0, 116);
    --color-boolean-true: rgb(46, 204, 64);
    --color-boolean-false: rgb(255, 65, 54);
    --color-null: rgb(128, 128, 128);

    /* 界面与文本颜色变量 */
    --color-text: #111111;                    /* Default 主题的 TEXT_COLOR */
    --color-viz-background: #ffffff;          /* Default 主题的 VIZ_BACKGROUND */

    /* 派生颜色或特定 UI 元素颜色 (示例) */
    --color-object-label-bg: rgba(198, 227, 198, 0.7); /* Default 主题 OBJECT 标签背景 */
    --color-array-label-bg: rgba(205, 217, 233, 0.7);  /* Default 主题 ARRAY 标签背景 */
    /* 如果叶子节点的背景不是其类型颜色，而是统一的 */
    /* --color-leaf-node-bg: #f0f0f0; */
}

[data-theme="Blue"] {
    --color-object: roklch(59.435% .077 254.027);
    --color-array: oklch(69.651% .059 248.687);
    --color-string: oklch(32.437% .022 264.182);
    --color-number: oklch(45.229% .035 264.131);
    --color-boolean-true: oklch(15.365% .014 131.063);
    --color-boolean-false: oklch(60.61% .12 15.341);
    --color-null: rgb(117, 113, 94);
    --color-text:oklch(76.827% .074 131.063);
    --color-viz-background: #272822;
    --color-object-label-bg: oklch(12.122% .024 15.341); 
    --color-array-label-bg: oklch(45.229% .035 264.131); 
}



[data-theme="Light"] {
    --color-object: rgba(133, 153, 0, 0.3);
    --color-array: rgba(38, 139, 210, 0.3);
    --color-string: rgb(42, 161, 152);
    --color-number: rgb(211, 54, 130);
    --color-boolean-true: rgb(133, 153, 0);
    --color-boolean-false: rgb(220, 50, 47);
    --color-null: rgb(101, 123, 131);
    --color-text: #586e75;
    --color-viz-background: #fdf6e3;
    --color-object-label-bg: rgba(140, 160, 30, 0.4);
    --color-array-label-bg: rgba(68, 149, 215, 0.4);
}
[data-theme="Forest"] {
    --color-object: hsl(120, 30%, 65%, 0.6); /* 柔和的绿色 */
    --color-array: hsl(150, 25%, 70%, 0.6);  /* 略带青色的绿色 */
    --color-string: #D2B48C;                 /* 树干棕褐色 (Tan) */
    --color-number: #8FBC8F;                 /* 暗海绿色 (DarkSeaGreen) */
    --color-boolean-true: #3CB371;           /* 中海绿色 (MediumSeaGreen) */
    --color-boolean-false: #CD5C5C;          /* 印度红 (IndianRed) */
    --color-null: #A9A9A9;                   /* 暗灰色 (DarkGray) */
    --color-text: #F5F5DC;                   /* 米色 (Beige) - 用于深色背景 */
    --color-viz-background: #2F4F2F;         /* 暗橄榄绿 (DarkOliveGreen) - 深色背景 */
    --color-object-label-bg: hsl(120, 30%, 70%, 0.75);
    --color-array-label-bg: hsl(150, 25%, 75%, 0.75);
}

[data-theme="Aqua"] {
    --color-object: oklch(80% 0.12 200 / 0.6); /* 浅水蓝 */
    --color-array: oklch(75% 0.15 220 / 0.6);  /* 稍深的蓝色 */
    --color-string: #FFD700;                  /* 金色 (Gold) - 对比 */
    --color-number: #00CED1;                  /* 暗宝石兰 (DarkTurquoise) */
    --color-boolean-true: #20B2AA;            /* 亮海洋绿 (LightSeaGreen) */
    --color-boolean-false: #FF6347;           /* 番茄色 (Tomato) */
    --color-null: #B0E0E6;                    /* 粉蓝色 (PowderBlue) */
    --color-text: #003366;                    /* 深海军蓝 - 用于浅色背景 */
    --color-viz-background: #E0FFFF;          /* 淡青色 (LightCyan) - 浅色背景 */
    --color-object-label-bg: oklch(83% 0.1 200 / 0.75);
    --color-array-label-bg: oklch(78% 0.13 220 / 0.75);
}

[data-theme="Luxury"] {
    --color-object: rgba(218, 165, 32, 0.4);  /* 金色 (Goldenrod alpha) */
    --color-array: rgba(128, 0, 32, 0.4);    /* 深勃艮第红 (Maroon/Burgundy alpha) */
    --color-string: #09090B;                 /* 卡其色 (Khaki) */
    --color-number: #513448;                 /* 暗金黄色 (DarkGoldenrod) */
    --color-boolean-true: #152747;           /* 暗橄榄绿 (DarkOliveGreen) */
    --color-boolean-false: #8B0000;          /* 暗红色 (DarkRed) */
    --color-null: #A0522D;                   /* 黄褐色 (Sienna) */
    --color-text: #DCA54D;                   
    --color-viz-background: #36013F;         /* 深紫色背景 (近似 Aubergine) */
    --color-object-label-bg: #1E1D1F;
    --color-array-label-bg: rgba(140, 20, 50, 0.55);
}

[data-theme="Dracula"] {
    --color-object: oklch(24.787% .019 277.508);  /* 使用primary-content颜色 */
    --color-array: oklch(14.84% .029 301.883);   /* 使用secondary-content颜色 */
    --color-string: oklch(16.678% .024 66.558);  /* 使用accent-content颜色 */
    --color-number: oklch(17.419% .043 148.024); /* 使用neutral-content颜色 */
    --color-boolean-true: oklch(17.419% .043 148.024); /* 使用success-content颜色 */
    --color-boolean-false: oklch(13.644% .041 24.43);  /* 使用error-content颜色 */
    --color-null: oklch(19.106% .026 112.757);   /* 使用warning-content颜色 */
    --color-text: oklch(74.202% .148 301.883);   /* 保持当前亮色系 */
    --color-viz-background: oklch(24.787% .019 277.508); /* 使用base-300颜色 */
    --color-object-label-bg: oklch(15.092% .036 346.812);
    --color-array-label-bg: oklch(14.84% .029 301.883);
}

[data-theme="Acid"] {
    --color-object: hsla(120, 100%, 50%, 0.4); /* 鲜绿色 (Lime Green alpha) */
    --color-array: hsla(300, 100%, 50%, 0.4);  /* 品红色 (Magenta alpha) */
    --color-string: #FFFF00;                  /* 纯黄 (Yellow) */
    --color-number: #00FFFF;                  /* 青色 (Cyan) */
    --color-boolean-true: #FF00FF;            /* 品红 (Magenta for true) */
    --color-boolean-false: #FF7F00;           /* 橙色 (Orange for false) */
    --color-null: #808080;                    /* 灰色 (Gray) */
    --color-text: #FFFFFF;                    /* 白色文字 */
    --color-viz-background: #1A1A1A;          /* 非常暗的灰色背景 */
    --color-object-label-bg: hsla(120, 100%, 55%, 0.55);
    --color-array-label-bg: hsla(300, 100%, 55%, 0.55);
}

/* 用户自定义主题CSS变量将通过 <style id="userThemeStyleSheet"> 注入 */
/* 它将定义 [data-theme="Custom"] { --color-object: ...; ... } */

/* ---------------- 基本应用样式 ---------------- */
body {
    font-family: sans-serif; margin: 0;
    background-color: #f4f4f4; /* 外层背景，非可视化区 */
    color: var(--color-text); /* 全局文本颜色，会被 #sidePanel 覆盖 */
    display: flex; flex-direction: row; height: 100vh; overflow: hidden;
}

#visualizationRoot {
    flex-grow: 1; border: 1px solid #ccc; padding: 10px;
    background-color: var(--color-viz-background);
    /* color: var(--color-text); /* 如果希望可视化区文本颜色也受主题控制 */
    box-shadow: 0 2px 4px rgba(0,0,0,0.1) inset; overflow: auto; height: 100%;
}

#sidePanel {
    width: 350px; flex-shrink: 0;
    background-color: #e9e9e9; /* 侧边栏背景固定或也用变量 */
    color: #333; /* 侧边栏文本颜色固定或也用变量 */
    box-shadow: -2px 0 4px rgba(0,0,0,0.1); padding: 15px; overflow-y: auto;
    height: 100%; box-sizing: border-box; display: flex; flex-direction: column;
}
#sidePanel h1 { font-size: 1.5em; margin-top: 0; margin-bottom: 15px; color: #333; text-align: center; }
#controls { margin-bottom: 20px; border-bottom: 1px solid #ddd; padding-bottom: 15px; }
#controls label, #controls input[type="file"], #controls p { display: block; margin-bottom: 8px; }
#controls input[type="file"] { width: 100%; }

/* --- Theme Cards & Modal (样式与之前类似, 但卡片预览的背景色等也应使用CSS变量) --- */
#themeCardsContainer { margin-top: 20px; }
#themeCardsContainer h2 { font-size: 1.2em; margin-bottom: 10px; text-align: center; }
.theme-card {
    border: 2px solid #ccc; border-radius: 6px; padding: 8px; margin-bottom: 12px;
    cursor: pointer; transition: border-color 0.3s, box-shadow 0.3s; position: relative;
}
.theme-card:hover { border-color: #888; box-shadow: 0 0 5px rgba(0,0,0,0.1); }
.theme-card.active { border-color: #007bff; box-shadow: 0 0 8px rgba(0,123,255,0.3); }

.theme-card-inner-preview { /* 预览区域 */
    border-radius: 4px; padding: 5px; text-align: center; overflow: hidden;
    /* JS在创建卡片时，会用 getPropertyValue 获取对应主题的变量值来设置这里的具体颜色 */
}
.theme-name-bar { /* 预览中的主题名称条 */
    font-weight: bold; padding: 4px 0; margin-bottom: 5px;
    border-radius: 3px; font-size: 0.9em;
}
.color-strip { /* 预览中的颜色条带 */
    display: flex; height: 20px; border-radius: 3px; overflow: hidden;
}
.color-block { flex-grow: 1; } /* 预览中颜色条带的小色块 */

.edit-custom-theme-btn { /* 编辑按钮 */
    position: absolute; top: 5px; right: 5px; font-size: 0.8em;
    padding: 3px 6px; background-color: #f0f0f0; border: 1px solid #ccc;
    border-radius: 3px; cursor: pointer;
}
.edit-custom-theme-btn:hover { background-color: #e0e0e0; }

#customThemeModal { /* 自定义主题模态框 */
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background-color: rgba(0,0,0,0.5); display: none; /* JS控制显示 */
    justify-content: center; align-items: center; z-index: 1000;
}
#customThemeModalContent {
    background-color: #fff; padding: 20px; border-radius: 8px;
    box-shadow: 0 5px 15px rgba(0,0,0,0.3); width: auto; max-width: 500px;
}
#customThemeModalContent h3 { margin-top: 0; }
#customThemeTextarea { width: 100%; box-sizing: border-box; font-family: monospace; margin-bottom: 10px; }
#customThemeModalActions { display: flex; justify-content: flex-end; gap: 10px; }
#customThemeStatus { margin-top: 10px; font-size: 0.9em; min-height: 1.2em; }

/* --- Legend Styles --- */
#legendContainer { margin-top: 25px; padding-top: 15px; border-top: 1px solid #ddd; }
#legendContainer h2 { font-size: 1.2em; margin-bottom: 10px; text-align: center;}
.legend-item {
    display: flex; align-items: center; margin-bottom: 6px;
    padding: 4px; border-radius: 3px; font-size: 0.9em;
    /* background-color: var(--color-viz-background); /* 图例项背景可设为可视化区背景的变体 */
}
.legend-color-swatch { /* 图例色块 */
    width: 18px; height: 18px; border: 1px solid rgba(0,0,0,0.2);
    margin-right: 8px; border-radius: 3px; flex-shrink: 0;
    /* 背景色将由JS根据当前主题的CSS变量动态设置 */
}
.legend-label { color: var(--color-text); } /* 图例文本 */


/* ---------------- JSON 节点样式 ---------------- */
.json-node {
    margin: 3px;
    border: 1px solid rgba(0,0,0,0.1); /* 边框颜色可以固定或也用变量 */
    border-radius: 4px;
    box-sizing: border-box;
    position: relative;
}

/* 容器节点背景色 */
.json-node.json-type-object.has-children-container { background-color: var(--color-object); }
.json-node.json-type-array.has-children-container { background-color: var(--color-array); }

/* 叶子节点背景色 */
.json-node.is-primitive-leaf.json-type-string { background-color: var(--color-string); }
.json-node.is-primitive-leaf.json-type-number { background-color: var(--color-number); }
.json-node.is-primitive-leaf.json-type-boolean-true { background-color: var(--color-boolean-true); }
.json-node.is-primitive-leaf.json-type-boolean-false { background-color: var(--color-boolean-false); }
.json-node.is-primitive-leaf.json-type-null { background-color: var(--color-null); }


.is-primitive-leaf { display: inline-block; vertical-align: top; padding: 1px 3px; min-height: 3em; overflow: hidden; min-width: 30%;}
.is-primitive-leaf .json-node-content-svg { height: 20px; min-height: 20px; }

.has-children-container { padding: 3px; }
.has-children-container > .node-label-svg { height: 22px; min-height: 22px; width: 100%; display: block; margin-bottom: 4px; cursor: pointer; border-radius: 2px; }
.has-children-container > .node-label-svg:hover { filter: brightness(1.1); } /* 这个 filter 可能需要根据主题调整 */

.node-children-container {
    padding-left: 15px; margin-left: 5px;
    border-left: 2px solid rgba(0,0,0,0.15); /* 这个颜色也可以用变量 */
    transition: max-height 0.3s ease-out, opacity 0.3s ease-out;
    overflow: hidden; opacity: 1;
}
.has-children-container.is-collapsed > .node-children-container { max-height: 0; opacity: 0; margin-top: 0; padding-top: 0; padding-bottom: 0; border-width: 0; }
.has-children-container.is-collapsed > .node-label-svg { margin-bottom: 0; }

/* ---------------- SVG 元素样式 ---------------- */
.svg-text {
    font-size: 10px;
    dominant-baseline: middle;
    pointer-events: none;
    fill: var(--color-text); /* SVG 文本颜色受主题控制 */
}
.svg-key-text {
    font-weight: bold;
    font-size: 11px;
    /* fill 继承自 .svg-text 或单独设置 */
}

/* SVG 矩形 (标签背景) */
.node-label-svg .svg-rect.rect-object-label-bg { fill: var(--color-object-label-bg); }
.node-label-svg .svg-rect.rect-array-label-bg { fill: var(--color-array-label-bg); }
/* SVG 矩形 (叶子节点背景 - 如果SVG rect也用于叶子节点) */
.json-node-content-svg .svg-rect.rect-string-bg { fill: var(--color-string); }
.json-node-content-svg .svg-rect.rect-number-bg { fill: var(--color-number); }
.json-node-content-svg .svg-rect.rect-boolean-true-bg { fill: var(--color-boolean-true); }
.json-node-content-svg .svg-rect.rect-boolean-false-bg { fill: var(--color-boolean-false); }
.json-node-content-svg .svg-rect.rect-null-bg { fill: var(--color-null); }

/* 一个通用的 .svg-rect，如果没有更具体的类，它可以用作回退或不设置fill让父级div背景透出 */
.svg-rect {
    /* stroke: var(--color-svg-rect-border); */ /* 如果需要边框 */
    /* stroke-width: 1px; */
}

</style>
<!-- 这个 style 标签用于 JS 注入用户自定义的主题 -->
<style id="userThemeStylesheet"></style>
</head>
<body data-theme="Default"> <!-- 或者在 #visualizationRoot 上设置 data-theme -->

    <div id="visualizationRoot">
        <!-- JSON 树将渲染在这里 -->
    </div>

    <div id="sidePanel">
        <h1>由JSON文件生成欧拉图</h1>
        <div id="controls">
            <label for="jsonFile">上传JSON文件:</label>
            <input type="file" id="jsonFile" accept=".json">
            <p id="status"></p>
        </div>

        <div id="themeCardsContainer">
            <h2>选择主题:</h2>
            <!-- Theme cards will be dynamically inserted here -->
        </div>

        <div id="legendContainer">
            <h2>图例:</h2>
            <div id="legendItems">
                <!-- Legend items will be dynamically inserted here -->
            </div>
        </div>
    </div>

    <!-- Custom Theme Modal -->
    <div id="customThemeModal" style="display: none;">
        <div id="customThemeModalContent">
            <h3>编辑自定义主题</h3>
            <p>请在下方文本框中定义 <code>[data-theme="Custom"] { ... }</code> CSS 规则，并包含以下自定义属性 (可以使用任何有效的CSS颜色值):</p>
            <pre><code id="cssVarExample" style="font-size: 0.8em; display: block; background: #f0f0f0; padding: 5px; border-radius: 3px; white-space: pre-wrap;">
                [data-theme="Custom"] {
                    --color-object: oklch(80% 0.1 150);  /* 对象背景色, 例如: oklch, hsl, #RRGGBB, rgba(), colorname */
                    --color-array: rgba(190, 210, 230, 0.7); /* 数组背景色 */
                    --color-string: #0074D9;             /* 字符串背景色 */
                    --color-number: plum;                /* 数字背景色 */
                    --color-boolean-true: limegreen;     /* 布尔值(true)背景色 */
                    --color-boolean-false: tomato;       /* 布尔值(false)背景色 */
                    --color-null: slategray;             /* Null值背景色 */
                
                    --color-text: oklch(20% 0.05 270);   /* 主要文本颜色 */
                    --color-viz-background: #fafafa;     /* 可视化区域背景色 */
                
                    /* 可选: 为容器标签定义不同的背景色 (如果未提供, SVG rect 将尝试使用对应类型的颜色) */
                    --color-object-label-bg: oklch(85% 0.08 150);
                    --color-array-label-bg: rgba(200, 220, 240, 0.85);
                }
                            </code></pre>
            <textarea id="customThemeTextarea" rows="15" cols="60"></textarea>
            <div id="customThemeModalActions">
                <button id="saveCustomThemeBtn">保存并应用</button>
                <button id="cancelCustomThemeBtn">取消</button>
            </div>
            <p id="customThemeStatus"></p>
        </div>
    </div>

    <script>
        // --- 常量与全局变量 ---
        const SVG_NS = "http://www.w3.org/2000/svg";
        const PRIMITIVE_SVG_HEIGHT = 20;
        const TEXT_PADDING_X = 5;

        // 主题相关常量
        const ACTIVE_THEME_NAME_STORAGE_KEY = 'jsonVizActiveThemeName';
        const CUSTOM_THEME_CSS_STORAGE_KEY = 'jsonVizUserCustomThemeCSS'; // 注意键名已更改
        const PREDEFINED_THEME_NAMES = [
            "Default",
            "Blue",
            "Light", 
            "Forest",
            "Aqua",
            "Luxury",
            "Dracula",
            "Acid"
        ];
        const ALL_THEME_CSS_COLOR_KEYS = [ // 用于生成图例和卡片预览，以及自定义主题提示
            "OBJECT", "ARRAY", "STRING", "NUMBER",
            "BOOLEAN_TRUE", "BOOLEAN_FALSE", "NULL",
            "TEXT", "VIZ_BACKGROUND",
            "OBJECT_LABEL_BG", "ARRAY_LABEL_BG" // 包含了可选的标签背景
        ];
         const THEME_KEY_TO_CHINESE_NAME = {
            OBJECT: '对象 (Object)',
            ARRAY: '数组 (Array)',
            STRING: '字符串 (String)',
            NUMBER: '数字 (Number)',
            BOOLEAN_TRUE: '布尔值: True',
            BOOLEAN_FALSE: '布尔值: False',
            NULL: '空值 (Null)',
            // TEXT 和 VIZ_BACKGROUND 通常不直接在类型图例中显示，但保留映射可能有用
            TEXT: '文本 (Text Color)',
            VIZ_BACKGROUND: '背景 (Viz Background)',
            OBJECT_LABEL_BG: '对象标签背景',
            ARRAY_LABEL_BG: '数组标签背景'
        };


        // 默认的用户自定义主题CSS规则 (当localStorage中没有时使用)
        const DEFAULT_USER_THEME_CSS_RULES = `
[data-theme="Custom"] {
    --color-object: oklch(80% 0.1 150);
    --color-array: rgba(190, 210, 230, 0.7);
    --color-string: #0074D9;
    --color-number: plum;
    --color-boolean-true: limegreen;
    --color-boolean-false: tomato;
    --color-null: slategray;
    --color-text: oklch(20% 0.05 270);
    --color-viz-background: #fafafa;
    --color-object-label-bg: oklch(85% 0.08 150);
    --color-array-label-bg: rgba(200, 220, 240, 0.85);
}`;

        let currentJsonData = null;
        let currentThemeName = "Default"; // 默认活动主题

        // --- DOM 元素引用 ---
        const vizRoot = document.getElementById('visualizationRoot');
        const THEME_TARGET_ELEMENT = document.body; // 主题 data-theme 属性应用在此元素上
        const fileInput = document.getElementById('jsonFile');
        const statusP = document.getElementById('status');
        const themeCardsContainer = document.getElementById('themeCardsContainer');
        const legendItemsContainer = document.getElementById('legendItems');

        const customThemeModal = document.getElementById('customThemeModal');
        const customThemeTextarea = document.getElementById('customThemeTextarea');
        const saveCustomThemeBtn = document.getElementById('saveCustomThemeBtn');
        const cancelCustomThemeBtn = document.getElementById('cancelCustomThemeBtn');
        const customThemeStatusP = document.getElementById('customThemeStatus');
        const userThemeStylesheet = document.getElementById('userThemeStylesheet');


        // --- 初始化 ---
        function initializeApp() {
            loadAndInjectUserCustomThemeCSS();
            generateAllThemeCards();

            const storedActiveThemeName = localStorage.getItem(ACTIVE_THEME_NAME_STORAGE_KEY);
            // 确保存储的主题名仍然有效，如果无效则回退到 Default
            if (PREDEFINED_THEME_NAMES.includes(storedActiveThemeName) || storedActiveThemeName === "Custom") {
                currentThemeName = storedActiveThemeName;
            } else {
                currentThemeName = "Default";
            }
            applyTheme(currentThemeName);

            // 事件监听器
            fileInput.addEventListener('change', handleFile);
            if (saveCustomThemeBtn) saveCustomThemeBtn.addEventListener('click', handleSaveCustomTheme);
            if (cancelCustomThemeBtn) cancelCustomThemeBtn.addEventListener('click', () => {
                if (customThemeModal) customThemeModal.style.display = 'none';
                if (customThemeStatusP) customThemeStatusP.textContent = '';
            });
        }

        // --- 主题管理 ---
        function loadAndInjectUserCustomThemeCSS() {
            let customThemeCSSRules = localStorage.getItem(CUSTOM_THEME_CSS_STORAGE_KEY);
            if (!customThemeCSSRules || customThemeCSSRules.trim() === "") {
                customThemeCSSRules = DEFAULT_USER_THEME_CSS_RULES;
                // 可选: 如果是第一次加载默认规则，可以将其存入 localStorage
                // localStorage.setItem(CUSTOM_THEME_CSS_STORAGE_KEY, customThemeCSSRules);
            }

            if (userThemeStylesheet) {
                userThemeStylesheet.textContent = customThemeCSSRules;
            } else {
                console.error("Element with ID 'userThemeStylesheet' not found. Cannot inject custom theme CSS.");
            }
        }

        function applyTheme(themeName) {
            currentThemeName = themeName;
            localStorage.setItem(ACTIVE_THEME_NAME_STORAGE_KEY, currentThemeName);
            THEME_TARGET_ELEMENT.dataset.theme = themeName; // 切换主题

            // 重新渲染JSON树 (如果已加载数据)
            if (currentJsonData) {
                renderJsonTree(currentJsonData, vizRoot, 'ROOT');
            }
            updateActiveCardVisuals();
            updateLegend();
        }

        function generateAllThemeCards() {
            if (!themeCardsContainer) return;
            themeCardsContainer.innerHTML = '<h2>选择主题:</h2>';

            PREDEFINED_THEME_NAMES.forEach(name => {
                themeCardsContainer.appendChild(createThemeCard(name));
            });
            themeCardsContainer.appendChild(createThemeCard("Custom")); // 为自定义主题创建卡片
            updateActiveCardVisuals();
        }

        function createThemeCard(themeName) {
            const card = document.createElement('div');
            card.classList.add('theme-card');
            card.dataset.themeName = themeName;
            card.title = `选择主题: ${themeName}`;

            const preview = document.createElement('div');
            preview.classList.add('theme-card-inner-preview');

            const nameBar = document.createElement('div');
            nameBar.classList.add('theme-name-bar');
            nameBar.textContent = themeName;

            const strip = document.createElement('div');
            strip.classList.add('color-strip');

            // 为了给卡片预览上色，我们需要获取对应主题的计算颜色值
            // 创建一个临时元素来应用主题并采样颜色
            const sampler = document.createElement('div');
            sampler.style.display = 'none'; // 不可见
            sampler.dataset.theme = themeName; // 应用目标主题
            THEME_TARGET_ELEMENT.appendChild(sampler); // 必须附加到DOM才能计算样式

            try {
                const computedStyles = window.getComputedStyle(sampler);
                preview.style.backgroundColor = computedStyles.getPropertyValue('--color-viz-background').trim();
                nameBar.style.backgroundColor = computedStyles.getPropertyValue('--color-object').trim();
                nameBar.style.color = computedStyles.getPropertyValue('--color-text').trim();
                strip.style.backgroundColor = computedStyles.getPropertyValue('--color-array').trim();

                ['STRING', 'NUMBER', 'BOOLEAN_TRUE', 'BOOLEAN_FALSE', 'NULL'].forEach(key => {
                    const block = document.createElement('span');
                    block.classList.add('color-block');
                    block.style.backgroundColor = computedStyles.getPropertyValue(`--color-${key.toLowerCase().replace('_', '-')}`).trim();
                    strip.appendChild(block);
                });
            } catch (e) {
                console.error(`Error sampling colors for theme card "${themeName}":`, e);
                // 预览失败时的回退样式
                preview.style.backgroundColor = "#eee";
                nameBar.style.backgroundColor = "#ccc";
                nameBar.style.color = "#333";
            } finally {
                THEME_TARGET_ELEMENT.removeChild(sampler); // 清理临时元素
            }

            preview.appendChild(nameBar);
            preview.appendChild(strip);
            card.appendChild(preview);

            if (themeName === "Custom") {
                const editButton = document.createElement('button');
                editButton.classList.add('edit-custom-theme-btn');
                editButton.textContent = '编辑';
                editButton.onclick = (e) => {
                    e.stopPropagation();
                    openCustomThemeModal();
                };
                card.appendChild(editButton);
            }

            card.addEventListener('click', () => applyTheme(themeName));
            return card;
        }

        function updateActiveCardVisuals() {
            const cards = document.querySelectorAll('#themeCardsContainer .theme-card');
            cards.forEach(card => {
                if (card.dataset.themeName === currentThemeName) {
                    card.classList.add('active');
                } else {
                    card.classList.remove('active');
                }
            });
        }

        function openCustomThemeModal() {
            let themeCSSText = localStorage.getItem(CUSTOM_THEME_CSS_STORAGE_KEY);
            if (!themeCSSText || themeCSSText.trim() === "") {
                themeCSSText = DEFAULT_USER_THEME_CSS_RULES;
            }
            if (customThemeTextarea) customThemeTextarea.value = themeCSSText;
            if (customThemeModal) customThemeModal.style.display = 'flex';
            if (customThemeStatusP) {
                customThemeStatusP.textContent = '';
                customThemeStatusP.style.color = '';
            }
        }

        function handleSaveCustomTheme() {
            if (!customThemeTextarea || !customThemeStatusP || !userThemeStylesheet) return;

            const newThemeCSSText = customThemeTextarea.value.trim();
            customThemeStatusP.textContent = '';

            if (newThemeCSSText === "") {
                customThemeStatusP.textContent = '错误: CSS 内容不能为空。';
                customThemeStatusP.style.color = 'red';
                return;
            }
            // 非常基础的检查，确保至少包含 [data-theme="Custom"]
            if (!newThemeCSSText.includes('[data-theme="Custom"]')) {
                 customThemeStatusP.textContent = '警告: CSS 定义应包含 [data-theme="Custom"] { ... } 规则。';
                 customThemeStatusP.style.color = 'orange';
                 // 仍然允许保存
            }

            localStorage.setItem(CUSTOM_THEME_CSS_STORAGE_KEY, newThemeCSSText);
            userThemeStylesheet.textContent = newThemeCSSText; // 立即应用新的CSS规则

            customThemeStatusP.textContent = '自定义主题CSS已保存!';
            customThemeStatusP.style.color = 'green';

            generateAllThemeCards(); // 重绘卡片以反映新的自定义主题预览

            // 如果当前主题是Custom，确保其被应用（虽然CSS已更新，但可能需要触发相关JS更新）
            if (currentThemeName === "Custom") {
                 applyTheme("Custom"); // 重新应用以确保图例等更新
            }

            setTimeout(() => {
                if (customThemeModal) customThemeModal.style.display = 'none';
                customThemeStatusP.textContent = '';
            }, 1500);
        }

        // --- 图例更新 ---
        function updateLegend() {
            if (!legendItemsContainer) return;
            legendItemsContainer.innerHTML = '';

            const computedStyles = window.getComputedStyle(THEME_TARGET_ELEMENT);

            // 只为数据类型相关的键创建图例项
            const legendColorKeys = ["OBJECT", "ARRAY", "STRING", "NUMBER", "BOOLEAN_TRUE", "BOOLEAN_FALSE", "NULL"];

            legendColorKeys.forEach(key => {
                const cssVarName = `--color-${key.toLowerCase().replace('_', '-')}`;
                const actualColor = computedStyles.getPropertyValue(cssVarName).trim();
                const chineseName = THEME_KEY_TO_CHINESE_NAME[key];

                if (actualColor && chineseName) {
                    const legendItem = document.createElement('div');
                    legendItem.classList.add('legend-item');

                    const swatch = document.createElement('div');
                    swatch.classList.add('legend-color-swatch');
                    swatch.style.backgroundColor = actualColor;
                    legendItem.appendChild(swatch);

                    const label = document.createElement('span');
                    label.classList.add('legend-label');
                    label.textContent = chineseName;
                    // label.style.color 由CSS的 .legend-label { color: var(--color-text); } 控制
                    legendItem.appendChild(label);

                    legendItemsContainer.appendChild(legendItem);
                }
            });
        }


        // --- 文件处理与JSON渲染 ---
        function handleFile(event) {
            const file = event.target.files[0];
            if (file && file.type === "application/json") {
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        currentJsonData = JSON.parse(e.target.result);
                        if(statusP) { statusP.textContent = "文件已加载，正在生成图表..."; statusP.style.color = '';}
                        renderJsonTree(currentJsonData, vizRoot, 'ROOT');
                        if(statusP) { statusP.textContent = "图表生成完毕。"; }
                    } catch (error) {
                        currentJsonData = null;
                        console.error("JSON 解析错误:", error);
                        if(statusP) { statusP.textContent = `JSON 解析错误: ${error.message}`; statusP.style.color = 'red';}
                        clearVisualization();
                    }
                };
                reader.onerror = function() {
                    currentJsonData = null;
                    if(statusP) { statusP.textContent = "文件读取错误。"; statusP.style.color = 'red';}
                    clearVisualization();
                }
                reader.readAsText(file);
            } else {
                if(file && statusP) {statusP.textContent = "请选择一个有效的.json文件。"; statusP.style.color = 'orange';}
            }
        }

        function clearVisualization() {
            if (vizRoot) vizRoot.innerHTML = '';
        }

        function renderJsonTree(data, parentHtmlElement, keyName) {
            if (parentHtmlElement === vizRoot) {
                clearVisualization();
            }
            const nodeDiv = document.createElement('div');
            nodeDiv.classList.add('json-node');

            let nodeType, fullDisplayText = '', shortDisplayText = '';
            let isContainer = false;
            let specificTypeClass = ''; // 用于更精确的CSS类名，例如 boolean-true
            let cssColorVarSuffix = ''; // 例如 'object', 'string', 'boolean-true'

            if (typeof data === 'string') {
                nodeType = 'string'; cssColorVarSuffix = 'string'; fullDisplayText = `"${data}"`;
                specificTypeClass = 'json-type-string';
            } else if (typeof data === 'number') {
                nodeType = 'number'; cssColorVarSuffix = 'number'; fullDisplayText = String(data);
                specificTypeClass = 'json-type-number';
            } else if (typeof data === 'boolean') {
                nodeType = 'boolean';
                cssColorVarSuffix = data ? 'boolean-true' : 'boolean-false';
                fullDisplayText = String(data);
                specificTypeClass = data ? 'json-type-boolean-true' : 'json-type-boolean-false';
            } else if (data === null) {
                nodeType = 'null'; cssColorVarSuffix = 'null'; fullDisplayText = 'null';
                specificTypeClass = 'json-type-null';
            } else if (Array.isArray(data)) {
                nodeType = 'array'; cssColorVarSuffix = 'array'; isContainer = true; fullDisplayText = `Array [${data.length}]`;
                specificTypeClass = 'json-type-array';
            } else if (typeof data === 'object') {
                nodeType = 'object'; cssColorVarSuffix = 'object'; isContainer = true; fullDisplayText = `Object {${Object.keys(data).length}}`;
                specificTypeClass = 'json-type-object';
            } else {
                return; // 未知类型
            }

            nodeDiv.classList.add(specificTypeClass); // e.g., json-type-object, json-type-boolean-true
            // 背景色由CSS通过 .json-node.json-type-object 等类名控制，这里不再设置 nodeDiv.style.backgroundColor

            if (!isContainer) {
                nodeDiv.classList.add('is-primitive-leaf');
            } else {
                nodeDiv.classList.add('has-children-container');
            }
            parentHtmlElement.appendChild(nodeDiv);

            // --- 创建SVG标签 ---
            const svg = createSvgElement('svg', {});
            svg.classList.add(isContainer ? 'node-label-svg' : 'json-node-content-svg');

            const rect = createSvgElement('rect', { x: 0, y: 0, width: '100%', height: '100%' });
            rect.classList.add('svg-rect'); // 通用类
            // 为rect添加更具体的类，以便CSS可以针对性地设置fill
            if (isContainer) {
                rect.classList.add(`rect-${cssColorVarSuffix}-label-bg`); // e.g., rect-object-label-bg
            } else {
                rect.classList.add(`rect-${cssColorVarSuffix}-bg`); // e.g., rect-string-bg (用于叶子节点SVG的背景)
            }
            svg.appendChild(rect);

            const textLabel = createSvgElement('text', { x: TEXT_PADDING_X, y: '50%' });
            textLabel.classList.add('svg-text'); // CSS会处理fill: var(--color-text)

            let effectiveKeyName = '';
            const parentIsArrayChildren = parentHtmlElement.classList.contains('json-array-children');
            if (keyName && keyName !== 'ROOT') {
                if (parentIsArrayChildren || !isContainer) {
                    effectiveKeyName = keyName;
                } else if (isContainer && !parentIsArrayChildren) {
                    effectiveKeyName = keyName;
                }
            }

            let fontSize = "10px";
            if (isContainer || (effectiveKeyName && !parentIsArrayChildren && keyName !== 'ROOT')) {
                fontSize = "11px";
            }

            // 估算宽度以设置叶子节点的最小宽度 (如果需要)
            if (!isContainer) {
                let fullLabelForWidth = (effectiveKeyName ? `${effectiveKeyName}: ` : '') + fullDisplayText;
                let estimatedWidth = estimateTextWidth(fullLabelForWidth, `${fontSize} sans-serif`) + (2 * TEXT_PADDING_X);
                nodeDiv.style.minWidth = `${Math.max(30, estimatedWidth)}px`; // 使用minWidth而不是width
                svg.style.height = `${PRIMITIVE_SVG_HEIGHT}px`;
            } else {
                svg.style.height = "22px";
            }

            shortDisplayText = fullDisplayText;
            const maxChars = isContainer ? 25 : 18;
            if (fullDisplayText.length > maxChars) {
                shortDisplayText = fullDisplayText.substring(0, maxChars - 3) + "...";
            }

            if (effectiveKeyName) {
                const keySpan = createSvgElement('tspan', { class: 'svg-key-text', 'font-size': fontSize });
                keySpan.textContent = `${effectiveKeyName}: `;
                textLabel.appendChild(keySpan);
            }
            const valueSpan = createSvgElement('tspan', { 'font-size': fontSize });
            valueSpan.textContent = shortDisplayText;
            textLabel.appendChild(valueSpan);

            if (isContainer) {
                const indicatorSpan = createSvgElement('tspan', { 'font-size': '9px', 'dx': '5px' });
                indicatorSpan.textContent = nodeDiv.classList.contains('is-collapsed') ? ' [+]' : ' [-]';
                indicatorSpan.classList.add('collapse-indicator');
                valueSpan.appendChild(indicatorSpan); // 将指示器附加到值后面

                svg.addEventListener('dblclick', function() { // 用 dblclick 折叠/展开
                    nodeDiv.classList.toggle('is-collapsed');
                    const indicator = this.querySelector('.collapse-indicator'); // 'this' 指向 svg
                    if (indicator) {
                        indicator.textContent = nodeDiv.classList.contains('is-collapsed') ? ' [+]' : ' [-]';
                    }
                });
            }
            svg.appendChild(textLabel);
            nodeDiv.appendChild(svg);

            if (isContainer) {
                const childrenContainerDiv = document.createElement('div');
                childrenContainerDiv.classList.add('node-children-container');
                childrenContainerDiv.classList.add(nodeType === 'array' ? 'json-array-children' : 'json-object-children');
                nodeDiv.appendChild(childrenContainerDiv);

                const childData = (nodeType === 'array') ? data : Object.entries(data);
                if (childData.length === 0) {
                    childrenContainerDiv.style.minHeight = '0px';
                    childrenContainerDiv.style.paddingLeft = '0px';
                    childrenContainerDiv.style.marginLeft = '0px';
                    childrenContainerDiv.style.borderLeft = 'none';
                    const indicator = svg.querySelector('.collapse-indicator');
                    if (indicator) indicator.textContent = ''; // 清空空容器的指示器
                } else {
                    if (nodeType === 'array') {
                        data.forEach((item, index) => {
                            renderJsonTree(item, childrenContainerDiv, `[${index}]`);
                        });
                    } else { // object
                        Object.entries(data).forEach(([propKey, propValue]) => {
                            renderJsonTree(propValue, childrenContainerDiv, propKey);
                        });
                    }
                }
                // 折叠状态由CSS的 .is-collapsed > .node-children-container 控制
            }
        }


        // --- 工具函数 ---
        function createSvgElement(tagName, attributes) {
            const el = document.createElementNS(SVG_NS, tagName);
            for (const key in attributes) {
                el.setAttribute(key, attributes[key]);
            }
            return el;
        }

        function estimateTextWidth(text, font = "10px sans-serif") {
            const canvas = estimateTextWidth.canvas || (estimateTextWidth.canvas = document.createElement("canvas"));
            const context = canvas.getContext("2d");
            context.font = font;
            const metrics = context.measureText(text);
            return metrics.width;
        }
        // lightenDarkenRgba 和 lightenDarkenColor 函数不再需要，因为颜色由CSS变量控制

        // --- 应用启动 ---
        initializeApp();

    </script>
</body>
</html>
